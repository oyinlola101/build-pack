#!/usr/bin/env bash

# Set variables
BUILD_DIR=$1
CACHE_DIR=$2

# Ensure the script is run in non-interactive mode
export DEBIAN_FRONTEND=noninteractive

# Install dependencies without superuser privileges
echo "-----> Installing dependencies..."

# Install Node Version Manager (nvm)
export NVM_DIR="$BUILD_DIR/.nvm"
mkdir -p $NVM_DIR
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash

# Explicitly source nvm and add it to the path
echo "-----> Sourcing nvm..."
source "$NVM_DIR/nvm.sh"
export PATH="$NVM_DIR/versions/node/v16.13.0/bin:$PATH"

# Install Node.js and Yarn
echo "-----> Installing Node.js and Yarn..."
nvm install 16.13.0
nvm use 16.13.0
npm install -g npm@9.7.2 yarn

# Install additional dependencies
echo "-----> Installing additional dependencies..."

# Download and install Go (Golang)
GO_VERSION="1.17.6"
GO_TAR="go$GO_VERSION.linux-amd64.tar.gz"
GO_URL="https://golang.org/dl/$GO_TAR"
curl -LO "$GO_URL"
tar -C "$BUILD_DIR" -xzf "$GO_TAR"
export PATH="$BUILD_DIR/go/bin:$PATH"
rm "$GO_TAR"

# Download and install Java (OpenJDK)
echo "-----> Installing Java (OpenJDK)..."
JDK_VERSION="11.0.11"
JDK_BUILD="9"
JDK_URL="https://github.com/adoptium/temurin11-binaries/releases/download/jdk-$JDK_VERSION%2B$JDK_BUILD/OpenJDK11U-jdk_x64_linux_hotspot_$JDK_VERSION\_$JDK_BUILD.tar.gz"
curl -L -o jdk.tar.gz "$JDK_URL"
tar -xzf jdk.tar.gz -C "$BUILD_DIR"
export JAVA_HOME="$BUILD_DIR/jdk-$JDK_VERSION+$JDK_BUILD"
export PATH="$JAVA_HOME/bin:$PATH"
rm jdk.tar.gz

# Install Python
echo "-----> Installing Python..."
PYTHON_VERSION="3.8.10"
PYTHON_DIR="$BUILD_DIR/python"
mkdir -p $PYTHON_DIR
curl -o $PYTHON_DIR/python.tgz https://www.python.org/ftp/python/$PYTHON_VERSION/Python-$PYTHON_VERSION.tgz
tar -xzf $PYTHON_DIR/python.tgz -C $PYTHON_DIR
cd $PYTHON_DIR/Python-$PYTHON_VERSION
./configure --prefix=$PYTHON_DIR && make && make install
export PATH="$PYTHON_DIR/bin:$PATH"
cd $BUILD_DIR

# Add Python binaries to PATH to avoid warnings
echo "-----> Adding Python binaries to PATH..."
export PATH="$PYTHON_DIR/bin:$PATH"

# Set up application directory
echo "-----> Setting up application directory..."
mkdir -p "$BUILD_DIR/app"
rsync -a --exclude="$BUILD_DIR/app" . "$BUILD_DIR/app/"

# Verify application directory setup
echo "-----> Verifying application directory setup..."
ls -al "$BUILD_DIR/app"

# Change to the application directory

# Output a success message
echo "-----> Buildpack compilation complete"
